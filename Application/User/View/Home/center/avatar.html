<extend name="./Application/Home/View/Public/layout.html"/>

<block name="style">
    <style type="text/css">
        .cropit-image-preview {
            background-image: url({$user_info.avatar|get_cover='avatar'});
            background-color: #f8f8f8;
            background-size: cover;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-top: 7px;
            width: 256px;
            height: 256px;
            cursor: move;
        }
        .cropit-image-zoom-input {
            width: 250px !important;
        }
        .cropit-image-background {
            opacity: .2;
            cursor: auto;
        }
        .image-size-label {
            margin-top: 10px;
        }
    </style>
</block>

<block name="script">
    <script type="text/javascript" src="__PUBLIC__/libs/jquery_cropit/jquery.cropit.js"></script>
    <script type="text/javascript">
        $(function() {
            // 头像上传 ie10+
            $('.image-editor').cropit();
            $('.submit').click(function() {
                var image_data = $('.image-editor').cropit('export');
                var blob = dataURItoBlob(image_data);
                var fd = new FormData();
                fd.append('file', blob);
                $.ajax({
                    url: '{:U()}' ,
                    type: 'POST',
                    data: fd,
                    async: false,
                    cache: false,
                    contentType: false,
                    processData: false,
                    success: function (data) {
                        if (data.status == 1) {
                            $.alertMessager(data.info, 'success');
                        } else {
                            $.alertMessager(data.info);
                        }
                    }
                });
            });

            function dataURItoBlob(dataURI) {
                // convert base64/URLEncoded data component to raw binary data held in a string
                var byteString;
                if (dataURI.split(',')[0].indexOf('base64') >= 0)
                    byteString = atob(dataURI.split(',')[1]);
                else
                    byteString = unescape(dataURI.split(',')[1]);

                // separate out the mime component
                var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];

                // write the bytes of the string to a typed array
                var ia = new Uint8Array(byteString.length);
                for (var i = 0; i < byteString.length; i++) {
                    ia[i] = byteString.charCodeAt(i);
                }

                return new Blob([ia], {type:mimeString});
            }
        });
    </script>
</block>

<block name="main">
    <div class="container">
        <div class="row">
            <div class="col-xs-12 col-md-3">
                <include file="side" /><!-- 包含用户中心侧边导航 -->
            </div>
            <div class="col-xs-12 col-md-9">
                <div class="panel panel-default">
                    <div class="panel-body">
                        <h4>更改头像</h4>
                        <div class="image-editor">
                            <input type="file" class="cropit-image-input">
                            <div class="cropit-image-preview"></div>
                            <div class="image-size-label">缩放图片</div>
                            <div class="form-group">
                                <input type="range" class="cropit-image-zoom-input">
                            </div>
                            <div class="form-group">
                                <button type="submit" class="submit btn btn-primary col-xs-12 col-sm-2">提交</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</block>
